<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>SceneVR â€“ Exercice 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: system-ui;
    }
    a-scene {
      position: fixed;
      inset: 0;
    }
    .hud {
      position: fixed;
      left: 12px;
      top: 12px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border-radius: 8px;
      z-index: 1000;
      pointer-events: none;
    }
    .hud-bottom {
      position: fixed;
      left: 12px;
      bottom: 12px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border-radius: 8px;
      z-index: 1000;
      pointer-events: none;
    }
    .loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0077be;
      color: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      font-size: 24px;
    }
    .loading .progress {
      width: 300px;
      height: 20px;
      background: #fff;
      border-radius: 10px;
      margin-top: 20px;
      overflow: hidden;
    }
    .loading .progress-bar {
      height: 100%;
      width: 0%;
      background: #4CAF50;
      transition: width 0.5s ease;
    }
  </style>
</head>
<body>
  <div class="loading">
    <div>Chargement de la scÃ¨ne VR...</div>
    <div class="progress">
      <div class="progress-bar" id="progress-bar"></div>
    </div>
  </div>

  <div class="hud">ðŸŽ® Gauche: dÃ©placer â€” Droite: tourner (desktop: stick droit = yaw + pitch)</div>
  <div class="hud-bottom">ðŸŽ¯ Bouton grip pour saisir/relÃ¢cher les objets</div>

  <a-scene
    renderer="antialias: true; colorManagement: true"
    physics="debug: false; driver: cannon">

    <!-- Assets -->
    <a-assets>
      <img id="grid" src="https://cdn.aframe.io/assets/images/grid.jpg">
    </a-assets>

    <!-- Sol -->
    <a-plane id="ground" static-body position="0 0 0" rotation="-90 0 0" width="40" height="40" material="src: #grid; repeat: 20 20" shadow="receive: true"></a-plane>

    <!-- Objets -->
    <a-box class="grabbable" position="-1 0.5 -3" depth="1" height="1" width="1" dynamic-body="mass: 2"
           material="color: #c94f4f; roughness: 0.8; metalness: 0.2"
           shadow="cast: true; receive: true"></a-box>
    <a-sphere class="grabbable" position="1 1 -2.5" radius="1" dynamic-body="mass: 2"
              material="color: #4f79c9; roughness: 0.6; metalness: 0.2"
              shadow="cast: true; receive: true"></a-sphere>

    <!-- LumiÃ¨res -->
    <a-light type="ambient" intensity="0.35" color="#FFF"></a-light>
    <a-light id="sun" type="directional" intensity="1" cast-shadow="true" shadow-bias="-0.0003"
             position="5 8 3" rotation="-45 30 0"></a-light>

    <!-- Ciel -->
    <a-sky color="#ECECEC"></a-sky>

    <!-- Rig + camÃ©ra + contrÃ´leurs -->
    <a-entity id="rig" position="0 1.6 5" movement-controls>
      <a-entity id="camera" camera position="0 1.6 0" look-controls wasd-controls>
      </a-entity>

      <!-- ContrÃ´leurs avec composants de saisie -->
      <a-entity id="left-hand" hand-controls="hand: left" grab-controls="hand: left"></a-entity>
      <a-entity id="right-hand" hand-controls="hand: right" grab-controls="hand: right"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    // Masquer l'Ã©cran de chargement une fois la scÃ¨ne chargÃ©e
    document.querySelector('a-scene').addEventListener('loaded', function() {
      document.querySelector('.loading').style.display = 'none';
    });

    // Simuler une barre de progression
    let progress = 0;
    const progressBar = document.getElementById('progress-bar');
    const progressInterval = setInterval(() => {
      progress += Math.random() * 10;
      if (progress >= 100) {
        progress = 100;
        clearInterval(progressInterval);
      }
      progressBar.style.width = progress + '%';
    }, 200);

    // Composant pour la saisie d'objets
    AFRAME.registerComponent('grab-controls', {
      schema: {
        hand: {type: 'string', default: 'right'},
        maxDistance: {type: 'number', default: 5}
      },
      init: function () {
        this.grabbedObject = null;
        this.isGripping = false;
        
        // Ã‰couter les Ã©vÃ©nements des boutons
        this.el.addEventListener('gripdown', this.onGripDown.bind(this));
        this.el.addEventListener('gripup', this.onGripUp.bind(this));
      },
      
      onGripDown: function() {
        if (this.grabbedObject) return;
        
        // Trouver tous les objets grabbable Ã  proximitÃ©
        const grabbables = document.querySelectorAll('.grabbable');
        let closest = null;
        let closestDistance = this.data.maxDistance;
        
        const handPosition = this.el.object3D.getWorldPosition(new THREE.Vector3());
        
        // Chercher l'objet le plus proche
        grabbables.forEach(obj => {
          const objPosition = obj.object3D.getWorldPosition(new THREE.Vector3());
          const distance = handPosition.distanceTo(objPosition);
          
          if (distance < closestDistance) {
            closest = obj;
            closestDistance = distance;
          }
        });
        
        if (closest) {
          this.grabObject(closest);
        }
      },
      
      onGripUp: function() {
        if (this.grabbedObject) {
          this.releaseObject();
        }
      },
      
      grabObject: function(object) {
        this.grabbedObject = object;
        
        // DÃ©sactiver la physique temporairement
        object.setAttribute('dynamic-body', 'mass', 0);
        
        // Attacher l'objet au contrÃ´leur
        this.el.appendChild(object);
        
        // Positionner l'objet devant le contrÃ´leur
        object.setAttribute('position', {x: 0, y: 0, z: -0.5});
      },
      
      releaseObject: function() {
        if (!this.grabbedObject) return;
        
        // DÃ©tacher l'objet du contrÃ´leur
        this.el.removeChild(this.grabbedObject);
        
        // Remettre l'objet dans la scÃ¨ne
        document.querySelector('a-scene').appendChild(this.grabbedObject);
        
        // RÃ©activer la physique
        this.grabbedObject.setAttribute('dynamic-body', 'mass', 2);
        
        // Appliquer une petite vitesse pour un lancer plus naturel
        const velocity = new THREE.Vector3(0, 0, -2);
        this.el.object3D.localToWorld(velocity);
        
        this.grabbedObject.body.velocity.set(velocity.x, velocity.y, velocity.z);
        
        this.grabbedObject = null;
      }
    });
  </script>
</body>
</html>