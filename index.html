<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>TP 4 WebVR - Exercices 1 Ã  4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <!-- aframe-extras (collider) -->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>

  <!-- Physics system -->
  <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.1.0/dist/aframe-physics-system.min.js"></script>

  <!-- super-hands -->
  <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

  <style>
    html, body { margin: 0; height: 100%; font-family: system-ui; }
    a-scene { position: fixed; inset: 0; }
    .hud, .instructions, .score {
      position: fixed;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      border-radius: 8px;
      z-index: 1000;
      pointer-events: none;
    }
    .hud { left: 12px; top: 12px; }
    .instructions { left: 12px; bottom: 12px; max-width: 300px; }
    .score { right: 12px; top: 12px; font-size: 18px; }
  </style>
</head>
<body>
  <div class="hud">TP 4 WebVR - Exercices 1 Ã  4</div>
  <div class="score">Cibles touchÃ©es: <span id="score">0</span></div>
  <div class="instructions">
    ðŸŽ® Gauche: dÃ©placer â€” Droite: tourner<br>
    ðŸ‘Š Main: attraper les objets (gÃ¢chette)<br>
    ðŸ”« GÃ¢chette: tirer avec l'arme<br>
    ðŸŽ¯ Touchez les cibles pour marquer des points
  </div>

  <a-scene
    physics="debug: false; gravity: -9.8;"
    renderer="antialias:true; physicallyCorrectLights:true; colorManagement:true; logarithmicDepthBuffer:true; sortTransparentObjects:true"
    shadow="type: pcfsoft"
    background="color: #87CEEB">

    <!-- Sol -->
    <a-entity id="ground"
      static-body
      geometry="primitive:plane;width:40;height:40"
      rotation="-90 0 0"
      material="color:#7da07d;roughness:1;metalness:0"
      shadow="receive:true"></a-entity>

    <!-- Table -->
    <a-entity id="table" position="0 0 -3">
      <a-box id="table-top"
        static-body
        position="0 3 0"
        width="3" height="0.05" depth="2"
        material="color:#8B4513;roughness:0.8;metalness:0.2"
        shadow="cast:true;receive:true"></a-box>
      <!-- Pieds -->
      <a-box static-body position="-1.2 0.375 -0.8" width="0.1" height="5.10" depth="0.1" material="color:#654321" shadow="cast:true"></a-box>
      <a-box static-body position="1.2 0.375 -0.8" width="0.1" height="5.10" depth="0.1" material="color:#654321" shadow="cast:true"></a-box>
      <a-box static-body position="-1.2 0.375 0.8" width="0.1" height="5.10" depth="0.1" material="color:#654321" shadow="cast:true"></a-box>
      <a-box static-body position="1.2 0.375 0.8" width="0.1" height="5.10" depth="0.1" material="color:#654321" shadow="cast:true"></a-box>
    </a-entity>

    <!-- Objets -->
    <a-box id="box1" position="-0.5 3.10 -2.5"
      depth="0.3" height="0.3" width="0.3"
      material="color:#c94f4f;roughness:0.8;metalness:0.2"
      dynamic-body="mass:1"
      shadow="cast:true;receive:true"
      grabbable
      class="interactable pushable-object"></a-box>

    <a-sphere id="sphere1" position="0.5 3.10 -2.5"
      radius="0.15"
      material="color:#4f79c9;roughness:0.6;metalness:0.2"
      dynamic-body="mass:1"
      shadow="cast:true;receive:true"
      grabbable
      class="interactable pushable-object"></a-sphere>

    <a-cylinder id="cylinder1" position="0 3.10 -3"
      radius="0.15" height="0.3"
      material="color:#4fc94f;roughness:0.7;metalness:0.2"
      dynamic-body="mass:1"
      shadow="cast:true;receive:true"
      grabbable
      class="interactable pushable-object"></a-cylinder>

    <!-- Cibles -->
    <a-entity id="targets"></a-entity>

    <!-- Arme -->
    <a-entity id="gun" position="0.2 -0.3 -0.5" scale="0.5 0.5 0.5">
      <a-box position="0 0 0" width="0.1" height="0.1" depth="0.3" material="color:#333"></a-box>
      <a-box position="0 0.05 0.15" width="0.1" height="0.2" depth="0.1" material="color:#555"></a-box>
    </a-entity>

    <!-- LumiÃ¨res -->
    <a-entity light="type:ambient;intensity:0.35;color:#fff"></a-entity>
    <a-entity id="sun" light="type:directional;intensity:1;castShadow:true;shadowBias:-0.0003"
      position="5 8 3" rotation="-45 30 0"></a-entity>

    <a-sky color="#87CEEB"></a-sky>

    <!-- Rig + cam + mains -->
    <a-entity id="rig" position="0 1.6 0">
      <a-entity id="pitch">
        <a-entity id="head" camera look-controls="pointerLockEnabled: true"></a-entity>

        <!-- Main gauche -->
        <a-entity id="left-hand"
          hand-controls="hand: left; handModelStyle: lowPoly"
          super-hands="grabStartButtons: trigger; grabEndButtons: trigger"
          sphere-collider="objects: .interactable; radius:0.06">
        </a-entity>

        <!-- Main droite -->
        <a-entity id="right-hand"
          hand-controls="hand: right; handModelStyle: lowPoly"
          super-hands="grabStartButtons: trigger; grabEndButtons: trigger"
          sphere-collider="objects: .interactable; radius:0.06"
          right-stick-turn
          gun-controller>
        </a-entity>
      </a-entity>
    </a-entity>

    <a-entity webxr="optionalFeatures: local-floor, bounded-floor"></a-entity>

    <!-- Scripts personnalisÃ©s -->
    <script>
      let score = 0;

      // Rotation avec stick droit
      AFRAME.registerComponent('right-stick-turn', {
        schema:{ turnSpeed:{type:'number',default:120}, deadzone:{type:'number',default:0.08} },
        init(){
          this.x=0;
          this.rig = document.querySelector('#rig');
          this.el.addEventListener('axismove', e => {
            this.x = e.detail.axis[0] || 0;
          });
        },
        tick(t,dt){
          if(!this.rig) return;
          if (Math.abs(this.x) >= this.data.deadzone) {
            const rot = this.rig.getAttribute('rotation') || {y:0};
            rot.y -= this.x * this.data.turnSpeed * (dt/1000);
            this.rig.setAttribute('rotation', rot);
          }
        }
      });

      // ContrÃ´le arme
      AFRAME.registerComponent('gun-controller', {
        init() {
          this.gun = document.querySelector('#gun');
          this.isGrabbing = false;
          this.el.addEventListener('grab-start', () => {
            this.isGrabbing = true;
            this.gun.setAttribute('position','0 0 0');
            this.el.appendChild(this.gun);
          });
          this.el.addEventListener('grab-end', () => {
            this.isGrabbing = false;
            this.gun.setAttribute('position','0.2 -0.3 -0.5');
            document.querySelector('#rig').appendChild(this.gun);
          });
          this.el.addEventListener('buttonchanged', (e) => {
            if (e.detail.id===0 && e.detail.state.pressed && this.isGrabbing) this.shoot();
          });
        },
        shoot() {
          const projectile = document.createElement('a-sphere');
          projectile.setAttribute('radius','0.05');
          projectile.setAttribute('material','color:yellow');
          projectile.setAttribute('dynamic-body','mass:0.1; shape:sphere; linearDamping:0.3');
          const gunPos = new THREE.Vector3();
          this.gun.object3D.getWorldPosition(gunPos);
          projectile.setAttribute('position', gunPos);
          const dir = new THREE.Vector3(0,0,-1);
          this.gun.object3D.localToWorld(dir);
          dir.sub(gunPos).normalize().multiplyScalar(30);
          projectile.setAttribute('velocity', dir);
          this.el.sceneEl.appendChild(projectile);
          setTimeout(()=>projectile.remove(),3000);
          projectile.addEventListener('collide', e=>{
            if (e.detail.body.el.id.includes('target')){
              score++;
              document.getElementById('score').textContent = score;
              e.detail.body.el.setAttribute('material','color:yellow');
              setTimeout(()=>e.detail.body.el.remove(),200);
            }
          });
        }
      });

      // GÃ©nÃ©rateur de cibles
      AFRAME.registerComponent('target-generator', {
        init(){ this.lastTarget=0; this.interval=2000; },
        tick(t){
          if (t-this.lastTarget>this.interval) {
            this.spawn(); this.lastTarget=t;
          }
        },
        spawn(){
          const cont=document.querySelector('#targets');
          if (cont.children.length>=8) return;
          const target=document.createElement('a-cylinder');
          target.setAttribute('id','target-'+Date.now());
          target.setAttribute('radius','0.3');
          target.setAttribute('height','0.05');
          target.setAttribute('material','color:red');
          target.setAttribute('position',{
            x:(Math.random()*15)-7.5,
            y:1.5,
            z:(Math.random()*15)-7.5
          });
          target.setAttribute('static-body','');
          cont.appendChild(target);
        }
      });

      document.querySelector('a-scene').addEventListener('loaded', ()=>{
        document.querySelector('a-scene').setAttribute('target-generator','');
      });
    </script>
  </a-scene>
</body>
</html>
